; --- Script tạo bộ cài MediaLed Interface (Bản chạy ngay) ---

; 1. CÁC ĐỊNH NGHĨA TÊN (Đã điền sẵn)
#define MyAppName "MediaLed Interface"
#define MyAppVersion "1.1.231225.5"
#define MyAppPublisher "MediaLed Team"
#define MyAppExeName "MediaLedInterface.exe"

[Setup]
; 2. MÃ ĐỊNH DANH (Đã tạo mã ngẫu nhiên mới, dùng luôn không cần sửa)
AppId={{C8F21D90-5B3A-4F2E-9A1C-7D4E8B2F3A10}}

; Thông tin hiển thị
AppName={#MyAppName}
AppVersion={#MyAppVersion}
AppPublisher={#MyAppPublisher}
DefaultDirName={autopf}\{#MyAppName}
DefaultGroupName={#MyAppName}

; Cấu hình kỹ thuật
ArchitecturesInstallIn64BitMode=x64
PrivilegesRequired=admin
Compression=lzma2/ultra64
SolidCompression=yes

; File đầu ra sẽ nằm ở C:\MediaLedSetup\Output
OutputBaseFilename=MediaLed_Setup_Install
OutputDir=C:\MediaLedSetup\Output

; Icon gỡ cài đặt lấy từ chính file exe
UninstallDisplayIcon={app}\{#MyAppExeName}

[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"

[Tasks]
Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

[Files]
; --- PHẦN QUAN TRỌNG NHẤT: ĐƯỜNG DẪN FILE ---

; 1. Copy file phần mềm (Đã chỉnh theo đường dẫn bạn gửi)
Source: "C:\MediaLedSetup\AppFiles\net8.0-windows10.0.19041.0\win-x64\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

; 2. Cài Font (Tự động)
Source: "C:\MediaLedSetup\Redist\Segoe Fluent Icons.ttf"; DestDir: "{autofonts}"; FontInstall: "Segoe Fluent Icons"; Flags: onlyifdoesntexist uninsneveruninstall

; 3. File cài đặt phụ (Copy vào thư mục tạm để chạy rồi xóa)
; LƯU Ý: Đảm bảo tên file trong thư mục Redist máy bạn đúng y hệt 2 tên này:
Source: "C:\MediaLedSetup\Redist\vc_redist.x64.exe"; DestDir: "{tmp}"; Flags: deleteafterinstall
Source: "C:\MediaLedSetup\Redist\K-Lite_Codec_Pack_Mega.exe"; DestDir: "{tmp}"; Flags: deleteafterinstall

[Icons]
Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon

[Run]
; --- CHẠY CÀI ĐẶT TỰ ĐỘNG (SILENT MODE) ---

; 1. Visual C++ (Chạy im lặng)
Filename: "{tmp}\vc_redist.x64.exe"; Parameters: "/install /quiet /norestart"; \
    StatusMsg: "Đang cài đặt Microsoft Visual C++..."; \
    Check: NeedInstallVC; Flags: waituntilterminated

; 2. K-Lite Codec (Chạy im lặng)
Filename: "{tmp}\K-Lite_Codec_Pack_Mega.exe"; Parameters: "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-"; \
    StatusMsg: "Đang cài đặt K-Lite Codec Pack..."; \
    Check: NeedInstallKLite; Flags: waituntilterminated

; 3. Chạy phần mềm sau khi xong
Filename: "{app}\{#MyAppExeName}"; Description: "Khởi động phần mềm"; Flags: nowait postinstall skipifsilent

[Code]
// --- HÀM KIỂM TRA ĐỂ KHÔNG CÀI LẠI NẾU ĐÃ CÓ ---

function NeedInstallVC: Boolean;
var
  RegKey: string;
begin
  RegKey := 'SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\x64';
  if RegKeyExists(HKLM, RegKey) then begin
    Result := False;
  end else begin
    Result := True;
  end;
end;

function NeedInstallKLite: Boolean;
begin
  if RegKeyExists(HKLM, 'SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\K-Lite Codec Pack_is1') or \
     RegKeyExists(HKLM64, 'SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\K-Lite Codec Pack_is1') then
  begin
    Result := False;
  end else begin
    Result := True;
  end;
end;